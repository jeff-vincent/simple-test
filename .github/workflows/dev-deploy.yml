name: Dev Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: "registry:5000"
  TAG: "${{ github.actor }}-${{ github.sha }}"

jobs:
  build-and-deploy:
    runs-on: [self-hosted, "${{ github.actor }}"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Clean builds directory
        shell: bash
        run: |
          rm -f /builds/*.done /builds/*.request /builds/*.processing \
                /builds/*.apply /builds/*.apply-done /builds/*.apply-log \
                /builds/*.apply-exitcode /builds/*.exitcode \
                /builds/*.log /builds/*.dest /builds/*.tar.gz \
                /builds/*.yaml /builds/*.sh

      # -- Build all images --

      - name: Patch gateway Dockerfile for Kaniko
        shell: bash
        run: |
          cd ${{ github.workspace }}/gateway
          sed -i 's/go build /go build -buildvcs=false /g' Dockerfile

      - name: Build gateway image
        uses: jeff-vincent/kindling/.github/actions/kindling-build@main
        with:
          name: gateway
          context: ${{ github.workspace }}/gateway
          image: "${{ env.REGISTRY }}/gateway:${{ env.TAG }}"

      - name: Patch inventory Dockerfile for Kaniko
        shell: bash
        run: |
          cd ${{ github.workspace }}/inventory
          sed -i '/^FROM /a ENV npm_config_cache=/tmp/.npm' Dockerfile

      - name: Build inventory image
        uses: jeff-vincent/kindling/.github/actions/kindling-build@main
        with:
          name: inventory
          context: ${{ github.workspace }}/inventory
          image: "${{ env.REGISTRY }}/inventory:${{ env.TAG }}"

      - name: Build orders image
        uses: jeff-vincent/kindling/.github/actions/kindling-build@main
        with:
          name: orders
          context: ${{ github.workspace }}/orders
          image: "${{ env.REGISTRY }}/orders:${{ env.TAG }}"

      - name: Patch ui Dockerfile for Kaniko
        shell: bash
        run: |
          cd ${{ github.workspace }}/ui
          sed -i '/^FROM /a ENV npm_config_cache=/tmp/.npm' Dockerfile

      - name: Build ui image
        uses: jeff-vincent/kindling/.github/actions/kindling-build@main
        with:
          name: ui
          context: ${{ github.workspace }}/ui
          image: "${{ env.REGISTRY }}/ui:${{ env.TAG }}"

      # -- Deploy in dependency order --

      - name: Deploy orders
        uses: jeff-vincent/kindling/.github/actions/kindling-deploy@main
        with:
          name: "${{ github.actor }}-orders"
          image: "${{ env.REGISTRY }}/orders:${{ env.TAG }}"
          port: "5000"
          ingress-host: "${{ github.actor }}-orders.localhost"
          health-check-path: "/api/v1/health"
          dependencies: |
            - type: postgres
            - type: redis
          env: |
            - name: LOG_LEVEL
              value: "debug"

      - name: Deploy inventory
        uses: jeff-vincent/kindling/.github/actions/kindling-deploy@main
        with:
          name: "${{ github.actor }}-inventory"
          image: "${{ env.REGISTRY }}/inventory:${{ env.TAG }}"
          port: "3000"
          ingress-host: "${{ github.actor }}-inventory.localhost"
          health-check-path: "/healthcheck"
          dependencies: |
            - type: mongodb
            - type: redis

      - name: Deploy gateway
        uses: jeff-vincent/kindling/.github/actions/kindling-deploy@main
        with:
          name: "${{ github.actor }}-gateway"
          image: "${{ env.REGISTRY }}/gateway:${{ env.TAG }}"
          port: "9090"
          ingress-host: "${{ github.actor }}-gateway.localhost"
          health-check-path: "/-/ready"
          env: |
            - name: ORDERS_URL
              value: "http://${{ github.actor }}-orders:5000"
            - name: INVENTORY_URL
              value: "http://${{ github.actor }}-inventory:3000"

      - name: Deploy ui
        uses: jeff-vincent/kindling/.github/actions/kindling-deploy@main
        with:
          name: "${{ github.actor }}-ui"
          image: "${{ env.REGISTRY }}/ui:${{ env.TAG }}"
          port: "80"
          ingress-host: "${{ github.actor }}-ui.localhost"
          env: |
            - name: GATEWAY_URL
              value: "http://${{ github.actor }}-gateway:9090"

      - name: Summary
        run: |
          echo "üéâ Deploy complete!"
          echo "üåê UI:  http://${{ github.actor }}-ui.localhost"
          echo "üåê Gateway: http://${{ github.actor }}-gateway.localhost"
          echo "üåê Orders: http://${{ github.actor }}-orders.localhost"
          echo "üåê Inventory: http://${{ github.actor }}-inventory.localhost"
